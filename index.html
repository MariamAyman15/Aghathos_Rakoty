<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>أيام وأيام</title>
  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --muted:#9fb0d0; --text:#eef3ff;
      --accent:#7dd3fc; --good:#34d399; --warn:#fbbf24; --bad:#fb7185; --blue:#60a5fa;
      --border:rgba(255,255,255,.10);
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial;
    }
    body{margin:0;background:linear-gradient(180deg,#070b14, #0b1220);color:var(--text);}
    .wrap{max-width:1120px;margin:0 auto;padding:18px;}
    .hero{display:flex;gap:14px;flex-wrap:wrap;align-items:flex-start;justify-content:space-between;}
    .title{font-size:28px;font-weight:950;letter-spacing:.2px}
    .sub{color:#dbe7ff;font-size:14px;margin-top:8px;line-height:1.95;max-width:820px}
    .pill{border:1px solid var(--border);padding:8px 12px;border-radius:999px;color:var(--muted);font-size:13px;white-space:nowrap}
    .grid{display:grid;grid-template-columns:1.35fr .65fr;gap:14px;margin-top:14px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }
    .card{background:rgba(17,26,46,.86);border:1px solid var(--border);border-radius:18px;padding:14px;box-shadow:0 10px 25px rgba(0,0,0,.25)}
    h3{margin:0 0 10px;font-size:16px}
    label{display:block;font-size:14px;margin:10px 0 6px;color:#dbe7ff}
    input[type="text"]{width:100%;background:#0a1020;border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:12px;font-size:14px;outline:none}
    .section{border:1px solid var(--border);border-radius:16px;padding:12px;margin:10px 0;background:rgba(10,16,32,.55)}
    .secTitle{display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:6px}
    .secTitle b{font-size:14px}
    .secHint{color:var(--muted);font-size:12px}
    .q{border-top:1px dashed rgba(255,255,255,.12);padding-top:10px;margin-top:10px}
    .q:first-child{border-top:none;padding-top:0;margin-top:0}
    .qText{font-size:13.5px;line-height:1.65;color:#eef3ff}
    .qRow{display:flex;gap:10px;align-items:center;margin-top:6px}
    .qRow input[type="range"]{width:100%}
    .val{min-width:56px;text-align:left;font-weight:950;font-variant-numeric: tabular-nums}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{
      border:1px solid var(--border);
      background:#0a1020;color:var(--text);
      padding:10px 12px;border-radius:12px;font-weight:950;cursor:pointer
    }
    button.primary{background:linear-gradient(90deg,#38bdf8,#22c55e);border:none;color:#041019}
    button.secondary{background:rgba(125,211,252,.12)}
    button.danger{background:rgba(251,113,133,.12);border:1px solid rgba(251,113,133,.35)}
    .tiny{font-size:12px;color:var(--muted);line-height:1.7}
    .resultBox{border-radius:16px;padding:12px;border:1px solid var(--border);background:rgba(10,16,32,.65)}
    .row{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
    .season{display:inline-flex;align-items:center;gap:8px;font-weight:950}
    .dot{width:10px;height:10px;border-radius:50%}
    .bar{height:8px;border-radius:999px;background:rgba(255,255,255,.10);overflow:hidden}
    .bar > i{display:block;height:100%;width:0;background:linear-gradient(90deg,#fb7185,#fbbf24,#34d399,#60a5fa)}
    .verse{margin-top:10px;line-height:1.9;color:#eef3ff}
    .verseRef{color:var(--muted);font-size:13px;margin-top:4px}
    .step{margin-top:10px;color:#dbe7ff;line-height:1.85}
    .mini{margin-top:10px;border-top:1px solid rgba(255,255,255,.12);padding-top:10px}
    .kpi{display:flex;justify-content:space-between;gap:10px;align-items:center;margin:10px 0}
    .kpi b{font-size:13px}
    .badge{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;color:#dbe7ff;background:rgba(255,255,255,.04)}
    .modalOverlay{
      position:fixed; inset:0; background:rgba(0,0,0,.65);
      display:flex; align-items:center; justify-content:center;
      padding:18px; z-index:50;
    }
    .modal{
      width:min(860px, 100%);
      border:1px solid var(--border);
      background:rgba(17,26,46,.96);
      border-radius:20px;
      padding:16px;
      box-shadow:0 20px 60px rgba(0,0,0,.5);
    }
    .modal h2{margin:0 0 8px;font-size:18px}
    .modal p{margin:0;color:#dbe7ff;line-height:1.85}
    .opts{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    @media (max-width:720px){ .opts{grid-template-columns:1fr} }
    .optBtn{
      text-align:right; padding:12px; border-radius:16px;
      border:1px solid var(--border); background:rgba(10,16,32,.55);
      color:var(--text); cursor:pointer; font-weight:950;
    }
    .optBtn small{display:block;margin-top:6px;color:var(--muted);font-weight:650;line-height:1.6}
    .modalFooter{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;align-items:center;margin-top:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <div>
        <div class="title">أيام وأيام</div>
        <div class="sub">
          «لأَنِّي عَرَفْتُ الأَفْكَارَ الَّتِي أَنَا مُفْتَكِرٌ بِهَا عَنْكُمْ، يَقُولُ الرَّبُّ، أَفْكَارَ سَلاَمٍ لاَ شَرٍّ، لِأُعْطِيَكُمْ آخِرَةً وَرَجَاءً.»
          <br><span class="tiny">(إرميا، 29، 11)</span>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <span class="badge">0 = لا يحدث</span>
          <span class="badge">5 = يحدث دائمًا</span>
          <span class="badge">الهدف: رجاء + خطوة واحدة للأمام</span>
        </div>
      </div>
      <div class="pill" id="weekPill">الأسبوع</div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>1) قيّم نفسك بصدق (0–5)</h3>

        <label>الاسم (اختياري)</label>
        <input id="name" type="text" placeholder="اكتب اسمك أو سيبه فاضي" />

        <label>خطوة واحدة هعملها خلال الاسبوع دا (اختياري)</label>
        <input id="stepInput" type="text" placeholder="مثال: هصلي 5 دقايق يوميًا + هبطل مقارنة نفسي" />

        <div id="sections"></div>

        <div class="btns">
          <button class="primary" id="calcBtn">اظهر النتيجة</button>
          <button id="saveBtn">احفظ المراجعة الأسبوعية</button>
          <button id="exportBtn">تصدير CSV</button>
          <button class="danger" id="clearBtn">مسح كل البيانات</button>
          <button class="secondary" id="openIntroBtn">شاشة البداية</button>
        </div>

        <div class="tiny" style="margin-top:10px">
          ⚠️ البيانات بتتحفظ على نفس الجهاز فقط. الهدف تشجيع مش مقارنة.
        </div>
      </div>

      <div class="card">
        <h3>2) نتيجتك (رجاء مش مقارنة)</h3>

        <div class="resultBox">
          <div class="row">
            <div class="season">
              <span class="dot" id="seasonDot"></span>
              <span id="seasonText">اضغط "اظهر النتيجة"</span>
            </div>
            <div class="tiny">النتيجة العامة: <b id="totalText">-</b>/150</div>
          </div>

          <div class="bar" style="margin-top:10px"><i id="totalBar"></i></div>

          <div class="verse" id="verse"></div>
          <div class="verseRef" id="verseRef"></div>
          <div class="step" id="nextStep"></div>

          <div class="mini" id="partsBox"></div>
        </div>

        <div style="margin-top:12px" class="tiny">آخر المراجعات (على نفس الجهاز):</div>
        <div id="historyWrap" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <!-- Intro Modal -->
  <div class="modalOverlay" id="introOverlay" style="display:none">
    <div class="modal">
      <h2>كيف تنتظر الأيام التي سوف تأتي؟</h2>
      <p>
        اختار إجابة واحدة كبداية… الهدف إننا نتمسك بالرجاء ونأخذ خطوة عملية بسيطة.
      </p>

      <div class="opts">
        <button class="optBtn" data-opt="babil">
          1) أقعد عند "أنهار بابل" وأفضل أفكر في اللي فات
          <small>حاسس إني واقف… وده بيأخرني.</small>
        </button>

        <button class="optBtn" data-opt="future">
          2) أقلق من المستقبل وأفقد الرجاء
          <small>محتاج كلمة رجاء تثبتني.</small>
        </button>

        <button class="optBtn" data-opt="compare">
          3) أستنى الآخرين/أقارن نفسي بالناس
          <small>عايز أركز على مسيرتي أنا مع الرب.</small>
        </button>

        <button class="optBtn" data-opt="move">
          4) أتحرك بخطوة صغيرة… وأثق إن الرب بيشتغل
          <small>مش هأستنى… هابدأ.</small>
        </button>
      </div>

      <div class="resultBox" id="introResult" style="margin-top:12px;display:none">
        <div class="verse" id="introText"></div>
        <div class="step" id="introStep"></div>
      </div>

      <div class="modalFooter">
        <div class="tiny">بعد الاختيار… جاوب على الأسئلة وخد "خطوة واحدة بسيطة للأسبوع".</div>
        <div class="btns" style="margin:0">
          <button id="closeIntroBtn">إغلاق</button>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  function isoWeekString(d=new Date()){
    const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = date.getUTCDay() || 7;
    date.setUTCDate(date.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
    const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1)/7);
    return `${date.getUTCFullYear()}-W${String(weekNo).padStart(2,'0')}`;
  }
  function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
  function pctFromTotal(total){ return clamp((total/150)*100,0,100); }
  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  // 5 parts × 6 questions = 30 questions total
  // Each question: 0..5
  // Each part: 0..30
  // Total: 0..150
  const blueprint = [
    {
      key:"spirit",
      title:"1- الحياة الروحية",
      hint:"هل في فتور؟ هل حضوره حاضر؟ هل في رجاء للغد؟",
      qs:[
        "هل أصبحت الأيام الروحية الآن أيام فتور؟",
        "أستطيع أن أشعر بحضور الله في يومي.",
        "كلمة الله بالنسبة لي حية ومش مجرد عادة.",
        "أستيقظ بانتظام/أحاول المشاركة في الصلاة والكنيسة (قدر الإمكان).",
        "لما أضعف أو أقع… برجع بسرعة بتوبة وصراحة.",
        "عندي رجاء إن الأيام اللي جاية ممكن تبقى أفضل مع الرب."
      ]
    },
    {
      key:"work",
      title:"2- العمل",
      hint:"هل أنا في المكان المناسب؟ هل بتقدم؟ ماذا أتوقع للغد؟",
      qs:[
        "أنا في وظيفة/مسار مهني مناسب لظروفي حاليًا.",
        "علاقتي بزملائي/فريقي محترمة وصحية.",
        "أنا أمين ومنضبط حتى لو مفيش حد بيراقبني.",
        "بلاحظ تطور حقيقي في مهاراتي أو خبرتي.",
        "مش بستسلم للضغط… بحاول أرتب وأتحرك بخطوات عملية.",
        "عندي خطة بسيطة للوصول لمرحلة أفضل في الأيام القادمة."
      ]
    },
    {
      key:"study",
      title:"3- الدراسة",
      hint:"ماذا عن الماضي؟ ماذا عن الآن؟ كيف أرى غدًا؟",
      qs:[
        "عندي اتزان تجاه الدراسة/التعلم (مش فوضى مستمرة).",
        "بشتغل على تطوير نفسي (مهارات/كورسات/قراءة).",
        "لما أفشل أو أتأخر… بتعلم وأقوم بدل ما أيأس.",
        "أقدر ألتزم بخطة واقعية حتى لو بسيطة.",
        "مصدق إن تعب النهارده له حصاد بكرة.",
        "عندي هدف واضح للمرحلة القادمة (حتى لو صغير)."
      ]
    },
    {
      key:"rel",
      title:"4- العلاقات / الصداقة",
      hint:"هل عندي شخص آمن؟ هل علاقتي صحية؟ هل في سلام؟",
      qs:[
        "عندي صديق/ة لصيق أقدر أتكلم معاه/معاها بصدق.",
        "أقدر أفتح أعماقي بدون خوف من الإدانة.",
        "علاقاتي بتدفعني للخير مش للضغط أو الخطية.",
        "بعرف أحط حدود صحية وأقول “لأ” لما لازم.",
        "بعرف أسامح وأطلب مسامحة بدل الكِبر أو القطيعة.",
        "مش بقارن نفسي بالآخرين بشكل يكسّرني."
      ]
    },
    {
      key:"serv",
      title:"5- الخدمة",
      hint:"هل في فتور؟ هل في نمو داخلي؟ ما الخطوة القادمة؟",
      qs:[
        "كان عندي (أو عندي) أحلام وغيرة للخدمة.",
        "أحيانًا بحس بفتور… لكن مش عايز أستسلم.",
        "خدمتي نابعة من علاقة مع الرب مش مجرد نشاط.",
        "أنا مستعد لروح الاتضاع (أخدم حتى لو مفيش ظهور).",
        "بدور على نمو داخلي حقيقي مش “شكل خادم”.",
        "عندي تصور/خطوة واضحة للخدمة في الأيام القادمة."
      ]
    }
  ];

  function renderSections(){
    const root = $("sections");
    root.innerHTML = blueprint.map(sec=>{
      const qsHtml = sec.qs.map((t,idx)=>{
        const id = `${sec.key}_${idx+1}`;
        return `
          <div class="q">
            <div class="qText">${t}</div>
            <div class="qRow">
              <input id="${id}" type="range" min="0" max="5" value="0" />
              <div class="val"><span id="v_${id}">0</span>/5</div>
            </div>
          </div>
        `;
      }).join("");
      return `
        <div class="section">
          <div class="secTitle">
            <b>${sec.title}</b>
            <span class="secHint">${sec.hint}</span>
          </div>
          ${qsHtml}
        </div>
      `;
    }).join("");
  }

  function bindAllSliders(){
    blueprint.forEach(sec=>{
      sec.qs.forEach((_,idx)=>{
        const id = `${sec.key}_${idx+1}`;
        const s = $(id), o = $(`v_${id}`);
        const sync = ()=> o.textContent = s.value;
        s.addEventListener("input", sync);
        sync();
      });
    });
  }

  function getScores(){
    const parts = {};
    blueprint.forEach(sec=>{
      let sum = 0; // 0..30
      sec.qs.forEach((_,idx)=>{
        sum += +$(`${sec.key}_${idx+1}`).value; // 0..5
      });
      parts[sec.key] = sum; // 0..30
    });
    const total = Object.values(parts).reduce((a,b)=>a+b,0); // 0..150
    return {parts, total};
  }

  // Hope-focused "seasons" (not comparing parts)
  function hopeSeason(total, parts){
    // gentle guardrail: very low spiritual score increases "need for restart" message
    const spirit = parts.spirit; // 0..30

    if (spirit <= 6 || total <= 40) return "بداية رجاء";
    if (total <= 85) return "رجاء يتثبت";
    if (total <= 120) return "رجاء يتحرك";
    return "رجاء يقود";
  }

  function seasonContent(season){
    switch(season){
      case "بداية رجاء":
        return {
          color: "var(--bad)",
          title: "بداية رجاء (مفيش حكم عليك)",
          verse: "حتى لو الأيام كانت صعبة… الرب يقدر يبدأ معاك من جديد. خطوة صغيرة صادقة أفضل من انتظار طويل.",
          ref: "لا تقف عند الألم… تحرك للأمام.",
          step: "خطوة واحدة للأسبوع: 5 دقايق صلاة يوميًا + قرار عملي واحد بسيط (تنظيم/مصالحة/تواصل/مذاكرة)."
        };
      case "رجاء يتثبت":
        return {
          color: "var(--warn)",
          title: "رجاء يتثبت",
          verse: "فيه رجاء… وده محتاج تثبيت عادة واحدة بدل التشتت. مش لازم كل حاجة تتغير مرة واحدة.",
          ref: "لا تيأس من المستقبل — الرب مازال يعمل.",
          step: "خطوة واحدة للأسبوع: عادة واحدة ثابتة 7 أيام (صلاة/كلمة/نظام نوم/مذاكرة) + شخص تتابع معاه."
        };
      case "رجاء يتحرك":
        return {
          color: "var(--good)",
          title: "رجاء يتحرك",
          verse: "أنت على الطريق… حافظ على الثبات. ما تبصّش على يوم واحد… بصّ للمسيرة كلها.",
          ref: "انظر إلى مسيرتك… وليس لمواقف متقطعة.",
          step: "خطوة واحدة للأسبوع: هدف أسبوعي واحد + 3 خطوات صغيرة + راحة صحية."
        };
      default:
        return {
          color: "var(--blue)",
          title: "رجاء يقود",
          verse: "جميل… خليك سبب رجاء لغيرك. الأيام مش لازم تبقى كلها سهلة… لكن تقدر تبقى كلها مع الرب.",
          ref: "يكفي أن تكون جميع الأيام مع الرب.",
          step: "خطوة واحدة للأسبوع: تابع شخص واحد/مسؤولية خدمة محددة + استمر في وقتك مع الرب."
        };
    }
  }

  function partLabel(key){
    return ({
      spirit:"الحياة الروحية",
      work:"العمل",
      study:"الدراسة",
      rel:"العلاقات/الصداقة",
      serv:"الخدمة"
    })[key] || key;
  }

  // Gentle, non-comparative encouragement per part
  function partEncourage(key, score){
    // score 0..30
    if (score <= 10){
      switch(key){
        case "spirit": return "رسالة رجاء: ابدأ من جديد بدون ضغط… 5 دقايق يوميًا تكفي كبداية.";
        case "work": return "رسالة رجاء: خطوة واحدة عملية هذا الأسبوع أفضل من لوم الظروف.";
        case "study": return "رسالة رجاء: مفيش فشل نهائي… فيه تعلم وقيام. ابدأ بخطة صغيرة.";
        case "rel": return "رسالة رجاء: اختار شخص أمين/ة وابدأ بصراحة تدريجيًا، وحدود صحية.";
        case "serv": return "رسالة رجاء: مش مهم الشكل… المهم القلب. خليك ثابت في خدمة بسيطة.";
      }
    }
    if (score <= 20){
      return "رسالة رجاء: أنت ماشي كويس جداً… ثبّت عادة واحدة واطلب مساندة/متابعة من حد تاني.";
    }
    return "رسالة رجاء: ممتاز… خليك سبب رجاء لغيرك بخطوة خدمة أو متابعة شخص.";
  }

  function renderResult(){
    const {parts, total} = getScores();
    const season = hopeSeason(total, parts);
    const c = seasonContent(season);

    $("seasonText").textContent = `${c.title}`;
    $("seasonDot").style.background = c.color;

    $("totalText").textContent = total;
    $("totalBar").style.width = `${pctFromTotal(total)}%`;

    $("verse").innerHTML = `<b>${escapeHtml(c.verse)}</b>`;
    $("verseRef").textContent = c.ref;

    const customStep = $("stepInput").value.trim();
    $("nextStep").innerHTML = customStep
      ? `<b>خطوتي المكتوبة:</b> ${escapeHtml(customStep)}`
      : `<b>اقتراح عملي:</b> ${escapeHtml(c.step)}`;

    // show parts as supportive indicators (no ranking)
    const partsHtml = Object.entries(parts).map(([k,v])=>{
      const pct = clamp((v/30)*100,0,100);
      return `
        <div class="kpi">
          <b>${partLabel(k)}</b>
          <span class="tiny"><b>${v}</b>/30</span>
        </div>
        <div class="bar"><i style="width:${pct}%"></i></div>
        <div class="tiny" style="margin-top:6px">${escapeHtml(partEncourage(k,v))}</div>
        <div style="height:10px"></div>
      `;
    }).join("");

    $("partsBox").innerHTML = `<b style="font-size:13px">مؤشرات تشجيعية (بدون مقارنة):</b><div style="margin-top:8px">${partsHtml}</div>`;

    return {parts, total, season, step: customStep || c.step};
  }

  // Intro modal logic
  function showIntro(choiceText, stepText){
    $("introResult").style.display = "block";
    $("introText").innerHTML = `<b>إجابتك:</b> ${escapeHtml(choiceText)}`;
    $("introStep").innerHTML = `<b>اقتراح عملي:</b> ${escapeHtml(stepText)}`;
  }

  function introChoice(opt){
    if (opt === "babil"){
      showIntro(
        "أقعد عند أنهار بابل وأفضل أفكر في اللي فات",
        "قرار صغير: النهارده هتحرك خطوة واحدة (صلاة 5 دقايق + ترتيب حاجة واحدة)."
      );
    } else if (opt === "future"){
      showIntro(
        "أقلق من المستقبل وأفقد الرجاء",
        "قرار صغير: هتمسك برجاء الرب… هكتب هدف أسبوعي واحد وأبدأ فيه فورًا."
      );
    } else if (opt === "compare"){
      showIntro(
        "أستنى الآخرين/أقارن نفسي بالناس",
        "قرار صغير: هبطل مقارنة… هركز على مسيري أنا وخطوة واحدة في طريقي."
      );
    } else {
      showIntro(
        "أتحرك بخطوة صغيرة… وأثق إن الرب بيشتغل",
        "قرار صغير: هثبت عادة واحدة الأسبوع ده وأتابعها 7 أيام."
      );
    }
  }

  // Weekly history
  const KEY = "ayyam_weekly_history_v2";
  function loadHistory(){ try{ return JSON.parse(localStorage.getItem(KEY) || "[]"); }catch{ return []; } }
  function saveHistory(items){ localStorage.setItem(KEY, JSON.stringify(items)); }
  function addEntry(entry){
    const h = loadHistory(); h.unshift(entry);
    saveHistory(h.slice(0,26));
  }

  function renderHistory(){
    const h = loadHistory();
    if(!h.length){
      $("historyWrap").innerHTML = `<div class="tiny">لا يوجد بيانات محفوظة بعد.</div>`;
      return;
    }
    const rows = h.slice(0,8).map(e=>{
      const pct = clamp((e.total/150)*100,0,100);
      return `
        <div class="resultBox" style="margin-bottom:10px">
          <div class="row">
            <div class="tiny"><b>${escapeHtml(e.week)}</b></div>
            <div class="tiny">${escapeHtml(e.season)}</div>
            <div class="tiny"><b>${e.total}</b>/150</div>
          </div>
          <div class="bar" style="margin-top:10px"><i style="width:${pct}%"></i></div>
          ${e.step ? `<div class="tiny" style="margin-top:10px"><b>خطوتي:</b> ${escapeHtml(e.step)}</div>` : ``}
        </div>
      `;
    }).join("");
    $("historyWrap").innerHTML = rows;
  }

  function exportCSV(){
    const h = loadHistory();
    if(!h.length){ alert("مفيش بيانات للتصدير."); return; }
    const header = ["week","name","total","season","spirit","work","study","rel","serv","step","createdAt"];
    const lines = [header.join(",")].concat(
      h.map(e => header.map(k => `"${String(e[k] ?? "").replace(/"/g,'""')}"`).join(","))
    );
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "ayyam_wa_ayyam_weekly_review.csv";
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  function clearAll(){
    if(!confirm("متأكد انك عاوز تمسح كل المراجعات المحفوظة على الجهاز؟")) return;
    localStorage.removeItem(KEY);
    renderHistory();
    alert("تم المسح.");
  }

  // init
  $("weekPill").textContent = `الأسبوع: ${isoWeekString()}`;
  renderSections();
  bindAllSliders();
  renderHistory();

  $("calcBtn").addEventListener("click", renderResult);
  $("saveBtn").addEventListener("click", ()=>{
    const r = renderResult();
    const entry = {
      week: isoWeekString(),
      name: ($("name").value || "").trim(),
      total: r.total,
      season: r.season,
      ...r.parts,
      step: r.step,
      createdAt: new Date().toISOString()
    };
    addEntry(entry);
    renderHistory();
    alert("اتحفظت ✅");
  });

  $("exportBtn").addEventListener("click", exportCSV);
  $("clearBtn").addEventListener("click", clearAll);

  // intro handlers
  $("openIntroBtn").addEventListener("click", ()=>{
    $("introOverlay").style.display = "flex";
    $("introResult").style.display = "none";
  });
  $("closeIntroBtn").addEventListener("click", ()=>{
    $("introOverlay").style.display = "none";
  });
  document.querySelectorAll(".optBtn").forEach(btn=>{
    btn.addEventListener("click", ()=> introChoice(btn.dataset.opt));
  });

  // open intro on first visit
  const seen = localStorage.getItem("ayyam_seen_intro_v2");
  if(!seen){
    $("introOverlay").style.display = "flex";
    localStorage.setItem("ayyam_seen_intro_v2","1");
  }
</script>
</body>
</html>

